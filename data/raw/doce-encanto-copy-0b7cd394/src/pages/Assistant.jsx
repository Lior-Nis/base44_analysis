import React, { useState, useRef, useEffect } from "react";
import { InvokeLLM } from "@/api/integrations";
import { Product, Order, User, Live, Aula, Coupon, CustomerMessage, CustomerReminder } from "@/api/entities";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { motion, AnimatePresence } from "framer-motion";
import { 
  Send, 
  Sparkles, 
  Bot, 
  User as UserIcon,
  Clock,
  ShoppingBag,
  Calendar,
  MapPin,
  Phone,
  Star,
  Heart,
  Loader2
} from "lucide-react";

import ChatMessage from "../components/assistant/ChatMessage";
import SuggestedQuestions from "../components/assistant/SuggestedQuestions";
import QuickActions from "../components/assistant/QuickActions";

export default function Assistant() {
  const [messages, setMessages] = useState([
    {
      id: 1,
      type: "bot",
      content: "Ol√°! Sou a assistente IA da Doce Encanto üßÅ\n\nSou especialista em confeitaria e conhe√ßo todo nosso aplicativo! Posso te ajudar com:\n\nüç∞ **Produtos & Card√°pio**\n‚Ä¢ Escolher produtos perfeitos para seu evento\n‚Ä¢ Personalizar pedidos especiais\n‚Ä¢ Sugest√µes por ocasi√£o e or√ßamento\n\nüì± **Navega√ß√£o no App**\n‚Ä¢ Como fazer pedidos (Vitrine Di√°ria e Encomendas)\n‚Ä¢ Usar cupons de desconto\n‚Ä¢ Acompanhar seus pedidos\n‚Ä¢ Gerenciar seu perfil\n\nüéâ **Planejamento de Eventos**\n‚Ä¢ Organizar festas de anivers√°rio\n‚Ä¢ Planejamento de casamentos\n‚Ä¢ Eventos corporativos\n‚Ä¢ Surpresas especiais\n\nüìö **Sala Learn**\n‚Ä¢ Aulas de confeitaria\n‚Ä¢ Receitas e t√©cnicas\n‚Ä¢ Dicas profissionais\n\nüí¨ **Suporte Geral**\n‚Ä¢ Informa√ß√µes sobre a empresa\n‚Ä¢ Hor√°rios e localiza√ß√£o\n‚Ä¢ Pol√≠ticas e procedimentos\n\nComo posso te ajudar hoje?",
      timestamp: new Date()
    }
  ]);
  const [currentMessage, setCurrentMessage] = useState("");
  const [isTyping, setIsTyping] = useState(false);
  const [userData, setUserData] = useState(null);
  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);

  useEffect(() => {
    loadUserData();
    scrollToBottom();
  }, []);

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const loadUserData = async () => {
    try {
      const user = await User.me();
      setUserData(user);
    } catch (error) {
      console.log("Usu√°rio n√£o logado");
    }
  };

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  const handleSendMessage = async (message = currentMessage) => {
    if (!message.trim()) return;

    const userMessage = {
      id: Date.now(),
      type: "user",
      content: message,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setCurrentMessage("");
    setIsTyping(true);

    try {
      // Buscar dados completos do contexto
      const [products, userOrders, lives, aulas, coupons] = await Promise.all([
        Product.list('-created_date', 50),
        userData ? Order.filter({ created_by: userData.email }, '-created_date', 20) : [],
        Live.list('-scheduled_date', 10),
        Aula.list('-created_date', 20),
        Coupon.filter({ is_active: true }, '-created_date', 10)
      ]);

      const context = `
        VOC√ä √â A ASSISTENTE IA ESPECIALIZADA DA "DOCE ENCANTO" - Confeitaria Artesanal Premium
        
        SOBRE A EMPRESA:
        - Nome: Doce Encanto Confeitaria Artesanal
        - Fundada em 2015 (9 anos de tradi√ß√£o e experi√™ncia)
        - Especialidades: Bolos personalizados, doces finos, salgados gourmet, doces para eventos
        - Hor√°rio: Ter√ßa a Domingo, 8h √†s 18h (fechado √†s segundas para planejamento)
        - Localiza√ß√£o: Centro da Cidade
        - Telefone: (11) 99999-9999
        - Email: contato@doceencanto.com.br
        - Miss√£o: Transformar momentos especiais em mem√≥rias ainda mais doces
        - Valores: Qualidade artesanal, ingredientes premium, atendimento personalizado

        PRODUTOS DISPON√çVEIS NO CARD√ÅPIO:
        ${products.map(p => `- ${p.name}: R$${p.price?.toFixed(2)} (${p.category})
          Descri√ß√£o: ${p.description}
          Quantidade m√≠nima: ${p.min_order_quantity || 1} unidade(s)
          Tags: ${p.tags?.join(', ') || 'Nenhuma'}
          ${p.published_today ? '‚ú® Dispon√≠vel hoje na Vitrine Di√°ria!' : ''}`).join('\n')}

        FUNCIONALIDADES DO APLICATIVO:
        
        üè† **P√ÅGINA INICIAL (Home)**
        - Apresenta√ß√£o da empresa e produtos em destaque
        - Acesso r√°pido √†s principais funcionalidades
        - Galeria de clientes e trabalhos realizados
        
        üç∞ **CARD√ÅPIO (Menu)**
        - Todos os produtos organizados por categoria
        - Filtros por pre√ßo, categoria e tags
        - Vitrine Di√°ria: produtos frescos dispon√≠veis para retirada no mesmo dia
        - Encomendas: pedidos personalizados com prazo de entrega
        
        üõí **SISTEMA DE PEDIDOS**
        - Vitrine Di√°ria: pedidos instant√¢neos para retirada
        - Encomendas: pedidos com personaliza√ß√£o e prazo
        - Carrinho de compras integrado
        - M√∫ltiplas formas de pagamento (PIX, cart√£o, dinheiro)
        
        üë§ **PAINEL DO CLIENTE**
        - Hist√≥rico completo de pedidos
        - Programa de fidelidade e pontos
        - Gerenciamento de perfil e prefer√™ncias
        - Lembretes de datas especiais
        
        üìö **SALA LEARN**
        - Videoaulas de confeitaria
        - Receitas exclusivas
        - T√©cnicas profissionais
        - E-books e materiais did√°ticos
        
        üí¨ **TESTEMUNHOS**
        - Avalia√ß√µes de clientes
        - Galeria de trabalhos realizados
        - Feedback e sugest√µes

        AULAS DISPON√çVEIS NA SALA LEARN:
        ${aulas.map(a => `- ${a.title} (${a.duration_minutes} min)
          Por: ${a.author}
          N√≠vel: ${a.level}
          Categoria: ${a.category}
          Visualiza√ß√µes: ${a.views || 0}`).join('\n')}

        LIVES PROGRAMADAS:
        ${lives.map(l => `- ${l.title}
          Data: ${new Date(l.scheduled_date).toLocaleDateString('pt-BR')}
          Plataforma: ${l.platform}
          Status: ${l.status}`).join('\n')}

        CUPONS ATIVOS:
        ${coupons.map(c => `- C√≥digo: ${c.code}
          Desconto: ${c.discount_type === 'percentage' ? c.discount_value + '%' : 'R$' + c.discount_value?.toFixed(2)}
          V√°lido at√©: ${c.expires_at ? new Date(c.expires_at).toLocaleDateString('pt-BR') : 'Sem prazo'}
          Aplic√°vel: ${c.applicable_to === 'all' ? 'Todos os pedidos' : c.applicable_to}`).join('\n')}

        ${userData ? `
        DADOS DO CLIENTE LOGADO:
        - Nome: ${userData.full_name}
        - Email: ${userData.email}
        - Telefone: ${userData.phone || 'N√£o informado'}
        - Pontos de Fidelidade: ${userData.loyalty_points || 0}
        - Anivers√°rio: ${userData.birthday ? new Date(userData.birthday).toLocaleDateString('pt-BR') : 'N√£o informado'}
        - Endere√ßo: ${userData.address || 'N√£o informado'}
        - Prefer√™ncias: ${userData.preferences?.join(', ') || 'Nenhuma cadastrada'}
        
        HIST√ìRICO DE PEDIDOS:
        ${userOrders.map(o => `- Pedido #${o.id.slice(-6)}: R$${o.total_amount?.toFixed(2)} 
          Status: ${o.status} | Tipo: ${o.order_type} | Data: ${new Date(o.created_date).toLocaleDateString('pt-BR')}`).join('\n')}
        ` : `
        USU√ÅRIO N√ÉO LOGADO:
        - Orientar sobre as vantagens de criar uma conta
        - Explicar o programa de fidelidade
        - Mostrar como acessar funcionalidades exclusivas
        `}

        ===== INSTRU√á√ïES ESPECIAIS =====
        
        üéØ **COMO AJUDAR COM PLANEJAMENTO DE EVENTOS:**
        1. Pergunte sobre o tipo de evento (anivers√°rio, casamento, corporativo, etc.)
        2. N√∫mero de convidados
        3. Or√ßamento dispon√≠vel
        4. Prefer√™ncias alimentares/restri√ß√µes
        5. Tema ou estilo desejado
        6. Data do evento
        7. Sugira produtos adequados e quantidades
        8. Ofere√ßa op√ß√µes de personaliza√ß√£o
        
        üç∞ **SUGEST√ïES POR OCASI√ÉO:**
        - Anivers√°rio infantil: Cupcakes coloridos, bolo tem√°tico, docinhos
        - Casamento: Bolo de noiva, bem-casados, mesa de doces finos
        - Corporativo: Salgados gourmet, caf√© da manh√£, coffee break
        - Anivers√°rio adulto: Bolos sofisticados, tortas, doces gourmet
        - Ch√° de beb√™: Doces em tons past√©is, cupcakes tem√°ticos
        
        üí° **DICAS DE NAVEGA√á√ÉO:**
        - Para pedidos r√°pidos: usar a Vitrine Di√°ria
        - Para eventos: fazer encomenda com anteced√™ncia
        - Para economizar: verificar cupons dispon√≠veis
        - Para aprender: acessar a Sala Learn
        - Para acompanhar: usar o Painel do Cliente
        
        üé® **PERSONALIZA√á√ÉO:**
        - Sempre pergunte sobre cores, temas, sabores preferidos
        - Sugira combina√ß√µes criativas
        - Explique possibilidades de personaliza√ß√£o
        - Oriente sobre prazos necess√°rios
        
        ===== REGRAS DE ATENDIMENTO =====
        
        ‚úÖ **SEMPRE FA√áA:**
        - Seja calorosa, acolhedora e profissional
        - Use emojis moderadamente para deixar a conversa agrad√°vel
        - Seja espec√≠fica e detalhada nas respostas
        - Ofere√ßa m√∫ltiplas op√ß√µes quando poss√≠vel
        - Personalize sugest√µes baseadas no perfil do cliente
        - Explique claramente como usar as funcionalidades
        - Incentive o cliente a explorar o aplicativo
        - Sugira produtos complementares quando apropriado
        
        ‚ùå **NUNCA FA√áA:**
        - Invente pre√ßos ou informa√ß√µes que n√£o tem
        - Prometa prazos irreais
        - D√™ informa√ß√µes conflitantes
        - Seja impessoal ou rob√≥tica
        - Ignore o contexto da conversa
        
        üîÑ **SEMPRE OFERE√áA:**
        - Ajuda adicional
        - Orienta√ß√£o sobre pr√≥ximos passos
        - Informa√ß√µes sobre promo√ß√µes
        - Sugest√µes personalizadas
        - Contato direto quando necess√°rio
        
        üí¨ **RESPOSTAS INTELIGENTES:**
        - Use o hist√≥rico do cliente quando relevante
        - Adapte o tom √† situa√ß√£o (festa alegre, evento formal, etc.)
        - Sugira produtos baseados em pedidos anteriores
        - Lembre de datas especiais cadastradas
        - Conecte diferentes funcionalidades do app
      `;

      const response = await InvokeLLM({
        prompt: `${context}\n\nPergunta/Solicita√ß√£o do cliente: ${message}`,
        add_context_from_internet: false
      });

      const botMessage = {
        id: Date.now() + 1,
        type: "bot",
        content: response,
        timestamp: new Date()
      };

      setMessages(prev => [...prev, botMessage]);
    } catch (error) {
      const errorMessage = {
        id: Date.now() + 1,
        type: "bot",
        content: "Desculpe, houve um erro tempor√°rio. Tente novamente em alguns instantes ou entre em contato diretamente pelo telefone (11) 99999-9999. üòî",
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsTyping(false);
    }
  };

  const handleSuggestedQuestion = (question) => {
    handleSendMessage(question);
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-50 to-amber-50 p-4 md:p-8">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          className="text-center mb-8"
        >
          <div className="flex items-center justify-center gap-3 mb-4">
            <div className="w-12 h-12 bg-gradient-to-br from-pink-500 to-amber-500 rounded-xl flex items-center justify-center shadow-lg">
              <Sparkles className="w-6 h-6 text-white" />
            </div>
            <h1 className="text-3xl md:text-4xl font-bold gradient-text">
              Assistente IA Especializada
            </h1>
          </div>
          <p className="text-gray-600 text-lg">
            Sua consultora pessoal em confeitaria e eventos especiais! üßÅ‚ú®
          </p>
        </motion.div>

        {/* Quick Actions */}
        <QuickActions onActionClick={handleSuggestedQuestion} />

        {/* Chat Container */}
        <Card className="glass-effect shadow-2xl border-pink-100 mb-6">
          <CardHeader className="border-b border-pink-100 bg-gradient-to-r from-pink-50 to-amber-50">
            <CardTitle className="flex items-center gap-2 text-pink-700">
              <Bot className="w-6 h-6" />
              Chat com Especialista IA
              <Badge className="bg-green-100 text-green-700 ml-auto">
                <div className="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse" />
                Online 24/7
              </Badge>
            </CardTitle>
          </CardHeader>
          
          <CardContent className="p-0">
            {/* Messages */}
            <div className="h-96 md:h-[500px] overflow-y-auto p-6 space-y-4">
              <AnimatePresence>
                {messages.map((message) => (
                  <ChatMessage key={message.id} message={message} />
                ))}
              </AnimatePresence>
              
              {isTyping && (
                <motion.div
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -10 }}
                  className="flex items-start gap-3"
                >
                  <div className="w-8 h-8 bg-gradient-to-br from-pink-500 to-amber-500 rounded-full flex items-center justify-center">
                    <Bot className="w-4 h-4 text-white" />
                  </div>
                  <div className="bg-white rounded-2xl rounded-tl-md p-4 shadow-sm border border-pink-100 max-w-xs">
                    <div className="flex items-center gap-1">
                      <div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce" />
                      <div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce delay-100" />
                      <div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce delay-200" />
                    </div>
                  </div>
                </motion.div>
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* Input */}
            <div className="border-t border-pink-100 p-6 bg-gradient-to-r from-pink-50/50 to-amber-50/50">
              <div className="flex gap-3">
                <Textarea
                  ref={inputRef}
                  value={currentMessage}
                  onChange={(e) => setCurrentMessage(e.target.value)}
                  onKeyPress={handleKeyPress}
                  placeholder="Digite sua mensagem... (Ex: 'Preciso organizar uma festa de 15 anos para 50 pessoas')"
                  className="resize-none border-pink-200 focus:border-pink-300 bg-white/80"
                  rows={1}
                  disabled={isTyping}
                />
                <Button
                  onClick={() => handleSendMessage()}
                  disabled={!currentMessage.trim() || isTyping}
                  className="bg-gradient-to-r from-pink-500 to-amber-500 hover:from-pink-600 hover:to-amber-600 text-white px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
                >
                  {isTyping ? (
                    <Loader2 className="w-5 h-5 animate-spin" />
                  ) : (
                    <Send className="w-5 h-5" />
                  )}
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Suggested Questions */}
        <SuggestedQuestions onQuestionClick={handleSuggestedQuestion} />
      </div>
    </div>
  );
}